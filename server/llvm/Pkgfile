version=3.5.0

source=(http://llvm.org/releases/$version/$name-$version.src.tar.gz
	http://llvm.org/releases/$version/cfe-$version.src.tar.gz
	http://llvm.org/releases/${version%.*}/compiler-rt-${version%.*}.src.tar.gz)

build() {
cd $name-$version.src

mv ../compiler-rt-${version%.*} projects/compiler-rt
mv ../cfe-$version.src tools/clang

case `uname -m` in
        x86_64)
                enable_pic="yes";;
        i?86)
                enable_pic="no";;
esac
sed -e 's:/docs/llvm:/share/doc/llvm-$version:' \
    -i Makefile.config.in

CC=gcc CXX=g++ \
./configure --prefix=/usr --sysconfdir=/etc \
--enable-libffi \
--datadir=/usr/share/$name \
--enable-shared \
--enable-optimized \
--disable-expensive-checks \
--enable-debug-runtime \
--disable-assertions \
--enable-threads
make || make -j1
make DESTDIR=$PKG install || make -j1 DESTDIR=$PKG install
for file in '$PKG/usr/lib/lib{clang,LLVM,LTO}*.a'
do
	test -f $file && chmod -v 644 $file
done

install -v -dm755 $PKG/usr/lib/clang-analyzer

for prog in scan-build scan-view
do
	cp -rfv tools/clang/tools/$prog $PKG/usr/lib/clang-analyzer/
	ln -sfv ../lib/clang-analyzer/$prog/$prog $PKG/usr/bin/
done

install -d $PKG/etc/ld.so.conf.d
echo /usr/lib/llvm > $PKG/etc/ld.so.conf.d/llvm.conf

ln -sfv /usr/bin/clang $PKG/usr/lib/clang-analyzer/scan-build/
mkdir -p $PKG//usr/share/man/man1

mv -v $PKG/usr/lib/clang-analyzer/scan-build/scan-build.1 $PKG/usr/share/man/man1/
}
