# Description: The latest stable kernel version
# URL: http://www.kernel.org
# Packagers: pierre at nutyx dot org,tnut at nutyx dot org

# PKGMK_IGNORE_UNPACK="yes"
PKGMK_NO_STRIP="yes"


name=kernel
version=3.19.0
release=1
_version=${version%.*}

source=(http://www.kernel.org/pub/linux/kernel/v3.x/linux-${_version}.tar.xz
# https://www.kernel.org/pub/linux/kernel/v3.x/patch-$version.xz
	kernel.config kernel.config_64 )

build(){

cd linux-${_version}

if [ -f $SRC/patch-$version.xz ]; then
	xz -d -c  $SRC/patch-$version.xz | patch -Np1
fi

make mrproper
case `uname -m` in
	x86_64)
		cp $SRC/kernel.config_64 ./.config;;
	i?86)
		cp $SRC/kernel.config ./.config;
esac

# make menuconfig

make || make -j1

case `uname -m` in
        x86_64)
		cp .config $SRC/kernel.config_64;;
        i?86)
		cp .config $SRC/kernel.config;;
esac

# Install modules
cd $SRC/linux-${_version}
sed -i "/rm\ -rf\ \$(MODLIB)\/kernel/d" Makefile
make INSTALL_MOD_PATH=$PKG modules_install || make -j1 INSTALL_MOD_PATH=$PKG modules_install
mkdir -p $PKG/boot
case `uname -m` in
        x86_64)
                cp  System.map \
                $PKG/boot/System_64.map-$version
                cp  .config    \
                $PKG/boot/config_64-$version
                cp  arch/x86_64/boot/bzImage \
                $PKG/boot/kernel-$version ;;
        i?86)
                cp  System.map \
                $PKG/boot/System.map-$version
                cp  .config \
                $PKG/boot/config-$version
                cp  arch/i386/boot/bzImage \
                $PKG/boot/kernel-$version ;;
esac
ln -sf kernel-$version $PKG/boot/kernel
cd $PKG/lib/modules/${version}/
rm -f {build,source}
ln -sv /usr/src/linux-${version} build
ln -sv /usr/src/linux-${version} source

# Firmware are in linux-firmware
rm -rf $PKG/lib/firmware
}
