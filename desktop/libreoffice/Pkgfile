version=4.3.1.2
PKGMK_IGNORE_UNPACK="yes"
_version=4.3.1
version_icu=4.2.3.3
release=1

source=(http://download.documentfoundation.org/libreoffice/src/${_version}/$name-$version.tar.xz
	http://download.documentfoundation.org/libreoffice/src/${_version}/$name-dictionaries-$version.tar.xz
	http://download.documentfoundation.org/libreoffice/src/${_version}/$name-help-$version.tar.xz
	http://download.documentfoundation.org/libreoffice/src/${_version}/$name-translations-$version.tar.xz)
#	http://www.linuxfromscratch.org/patches/blfs/svn/libreoffice-$version-gcc_4_9_0-1.patch)

build() {
        unset ACLOCAL
        export LO_PREFIX=/usr

	cd $SRC
	tar -xf $name-$version.tar.xz --no-overwrite-dir

	cd $name-$version
	install -dm755 src
	tar -xf ../$name-dictionaries-$version.tar.xz --no-overwrite-dir --strip-components=1
	tar -xf ../$name-help-$version.tar.xz --no-overwrite-dir --strip-components=1

	ln -sv $SRC/libreoffice-dictionaries-$version.tar.xz src/
	ln -sv $SRC/libreoffice-help-$version.tar.xz src

	tar -xf ../$name-translations-$version.tar.xz --strip-components=1
	ln -sv $SRC/libreoffice-translations-$version.tar.xz src/

#	[ "`uname -m`" == "i686" ] && patch -Np1 -i $SRC/libreoffice-$version-gcc_4_9_0-1.patch

        sed -e "/gzip -f/d"   \
            -e "s|.1.gz|.1|g" \
            -i bin/distro-install-desktop-integration
   
        sed -e "/distro-install-file-lists/d" -i Makefile.in

        sed -e "/distro-install-file-lists/d"           \
            -e "s:fetch_Download_item:&_unchecked:"     \
            -e "/fetch_Download_item/s:,no-check::"     \
            -i Makefile.in

	chmod -v +x bin/unpack-sources

        sed -e "s/target\.mk/langlist\.mk/"                \
            -e "s/tar -xf/tar -x --strip-components=1 -f/" \
            -e "/tar -x/s/lo_src_dir/start_dir/"           \
            -i bin/unpack-sources 
                    
./autogen.sh --prefix=$LO_PREFIX         \
             --sysconfdir=/etc           \
             --with-vendor="BLFS"        \
             --with-lang="es de fr it pt fi nb nl da sv"   \
             --with-help                 \
             --with-alloc=system         \
             --without-java              \
             --disable-gconf             \
             --disable-odk               \
             --disable-postgresql-sdbc   \
             --enable-release-build=yes  \
             --enable-python=system      \
             --with-system-boost         \
             --with-system-clucene       \
             --with-system-cairo         \
             --with-system-curl          \
             --with-system-expat         \
             --with-system-graphite      \
             --with-system-harfbuzz      \
             --with-system-icu           \
             --with-system-jpeg          \
             --with-system-lcms2         \
             --with-system-libpng        \
             --with-system-libxml        \
             --with-system-mesa-headers  \
             --with-system-neon          \
             --with-system-npapi-headers \
             --with-system-nss           \
             --with-system-odbc          \
             --with-system-openldap      \
             --with-system-openssl       \
             --with-system-poppler       \
             --with-system-redland       \
             --with-system-zlib          \
             --with-parallelism=$(getconf _NPROCESSORS_ONLN)	
	
	make build
	make DESTDIR=$PKG distro-pack-install

	install -v -m755 -d $PKG/$LO_PREFIX/share/appdata
	install -v -m644    sysui/desktop/appstream-appdata/*.xml $PKG/$LO_PREFIX/share/appdata

	# Installation des Dictionnaires 
	chown -cR 0:0 dictionaries/ 
	for lang in en fr_FR es de it_IT pt_PT no nl_NL sv_SE da_DK
	do
	  mkdir -pv $PKG/$LO_PREFIX/lib/libreoffice/share/extensions/dict-$lang
	  cp -R dictionaries/$lang/* $PKG/$LO_PREFIX/lib/libreoffice/share/extensions/dict-$lang
	done
		 
	# Icones
	for res in 16 32 48 128 256
	do
	  mkdir -p $PKG/$LO_PREFIX/share/icons/hicolor/${res}x${res}/{apps,mimetypes}
	  cp sysui/desktop/icons/hicolor/${res}x${res}/apps/*.png \
	  	$PKG/$LO_PREFIX/share/icons/hicolor/${res}x${res}/apps
	  cp sysui/desktop/icons/hicolor/${res}x${res}/mimetypes/*.png \
	  	$PKG/$LO_PREFIX/share/icons/hicolor/${res}x${res}/mimetypes
	done

#	mkdir -pv $PKG/usr/share/pixmaps
#	for i in writer base calc draw impress math startcenter
#	do
#  	  ln -sf $PKG/$LO_PREFIX/share/icons/hicolor/32x32/apps/libreoffice-$i.png \
#          	$PKG/usr/share/pixmaps/
#	done
#	unset i
        
	# Nettoyage
	rm -rf $PKG/gid*
}
