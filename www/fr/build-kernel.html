<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
     <link rel="shortcut icon" href="../favicon.ico">
     <link rel="stylesheet" href="../css/nutyx.css" />
  <title>NuTyX - Compiler et installer son noyau</title>
 </head>
    
 <body>
     <header>    
      <a href=".."><img id="logo" src="../graphics/logo_nutyx_120.png" alt="logo nutyx" /></a>
    </header>
       
    <nav>
        <ul>
            <li><a href=".">Accueil</a></li>
            <li><a href="http://forum.nutyx.org/index.php?action=recent">Forum</a></li>
            <li><a href="irc.html">Salon IRC</a></li>
            <li><a href="documentation.html">Documentation</a></li>
            <li><a href="install.html">Installation</a></li>
            <li><a href="contribute.html">Contribuer</a></li>
            <li><a href="information.html">Information</a></li>
            <li><a href="https://twitter.com/nutyx_linux">Twitter</a></li>
            <li><a href="http://git.tuxfamily.org/?p=nutyx/saravane.git">Derniers changements</a></li>
            <li><a href="http://downloads.nutyx.org/saravane/latest/system/">Paquets "system"</a></li>
            <li><a href="http://downloads.nutyx.org/saravane/latest/server/">Paquets "server"</a></li>
            <li><a href="http://downloads.nutyx.org/saravane/latest/desktop/">Paquets "desktop"</a></li>
        </ul>
    </nav>
     
        <!-- FIN HEADER -->

  <h1>Compiler et installer son propre noyau</h1>
     
  <p>Cet article peut s'appliquer à toute autre distribution.</p>
     <p>Si vous avez installé NuTyX et que vous avez décidé de ne pas installer de kernel disponible dans les dépots et donc de compiler vous-même votre kernel, cet article vous explique sommairement comment compiler et installer un kernel personnalisé.</p>
     
  <p>Il existe beaucoup de raisons de vouloir compiler son propre kernel. Avoir un kernel optimisé en taille et pour son propre matériel est sans doute la plus fréquente. Il faut savoir que les étapes 4 et 5 peuvent être refaites à l'infini (dans le cas où le kernel ne booterai pas par exemple). Voici les différentes étapes à suivre :</p>
     
  <ul>
      <li>Télécharger les sources du kernel sur le site <a href="http://kernel.org" title="Lire dans une autre fenêtre" class="external" onclick="window.open(this.href); return false;">http://kernel.org</a></li>
      <li>Se mettre dans le dossier /usr, créer un dossier src et extraire les sources du kernel téléchargées en point 1 dans le dossier /usr/src</li>
      <li>Se rendre dans le dossier du kernel et taper les commandes magiques pour configurer les options qui nous semblent utiles</li>
      <li>Configurer les options de compilation et lancer la compilation du kernel</li>
      <li>Installer les modules et le kernel dans les bons dossiers</li>
      <li>Optionnel (si vous avez déjà un kernel) créer une nouvelle entrée dans le fichier grub.cfg ou menu.lst</li>
  </ul>
     
  <h4>Télécharger les sources du kernel</h4>
     
    <p>Pour pouvoir compiler un kernel, il faut donc commencer par récupérer les sources d'une version de kernel. Au moment de l'écriture de l'article, la version 3.12.3 est disponible. Nous allons donc prendre le risque de le compiler...</p>
     <p>Ouvrez un terminal et tapez la commande :</p>
   <pre class="command"><kbd>wget http://www.kernel.org/pub/linux/kernel/v3.x/linux-3.12.3.tar.xz</kbd>
   </pre>
   <p>Les sources commencent à se télécharger dans votre dossier personnel
   </p>
   <pre class="output">--2012-09-01 17:49:53--  http://www.kernel.org/pub/linux/kernel/v3.0/testing/linux-3.12.3.tar.xz
Résolution de www.kernel.org... 149.20.4.69, 149.20.20.133
Connexion vers www.kernel.org|149.20.4.69|:80...connecté.
requête HTTP transmise, en attente de la réponse...200 OK
Longueur: 82259123 (78M) [application/x-bzip2]
Sauvegarde en : &laquo;linux-3.6-rc3.tar.bz2&raquo;

100%[=============================&gt;] 82.259.123  2,55M/s   ds 37s     

2012-09-01 17:50:31 (2,13 MB/s) - &laquo;linux-3.12.3.tar.xz&raquo; sauvegardé [82259123/82259123]
   </pre>
   <div class="note"><img src="../graphics/note.gif" width="10" height="10" alt="*" /> Si vous procédez à la manipulation au moment de l'installation, vous êtes déjà en compte root et le fichier sera téléchargé dans le dossier /root de votre NuTyX
   </div>
     <p>Une fois que les sources sont récupérées, on va les mettre au bon endroit.</p>
     
   <h4>Se mettre dans le dossier /usr, créer le bon dossier et extraire les sources du kernel dans le dossier /usr/src</h4>
   <div class="important"><img src="http://nutyx.org/skins/_reference/codes/important.gif" width="10" height="10" alt="!!!" /> A partir de maintenant toutes les op&eacute;rations se font dans le compte root. Soyez donc tr&egrave;s prudent.</div>
     <div class="note"><img src="http://nutyx.org/skins/_reference/codes/note.gif" width="10" height="10" alt="*" /> Si vous proc&eacute;dez depuis l''installateur, la commande ci-dessous est inutile</div>

     <pre class="command"><kbd>>su -
passworrd:</kbd>
   </pre>
   <p>Entrez le mot de passe du compte root. On peut maintenant créer un dossier</p>
   <pre class="command"><kbd>mkdir /usr/src</kbd>
   </pre>
   <p>Il est possible que vous soyez insult&eacute; avec le message suivant:
   </p>
   <pre class="output">mkdir: impossible de créer le répertoire &laquo; /usr/src &raquo;: Le fichier existe
   </pre>
   <p>Vous pouvez l'ignorer, maintenant on entre dans ce dossier.
   </p>
   <pre class="command"><kbd>cd /usr/src</kbd>
   </pre>
   <p>On extrait les sources du kernel téléchargées :</p>
     
   <pre class="command"><kbd>tar xf /home/thierry/linux-3.12.3.tar.xz</kbd>
   </pre>
   <div class="note"><img src="../graphics/note.gif" width="10" height="10" alt="*" /> Veuillez remplacer le dossier thierry par votre compte personnel
   </div>
   <p>Après quelques minutes, le prompt sera à nouveau disponible et les sources du kernel seront en place. Se rendre dans le dossier du kernel et taper les commandes magiques pour configurer les options qui nous semblent utiles. Pour pouvoir compiler le kernel, il faut être dans le dossier sources de celui-ci, tapez dans votre console :</p>
     
   <pre class="command"><kbd>cd /usr/src/linux-3.12.3</kbd>
   </pre>
   <p>Nous sommes maintenant pr&ecirc;t &agrave; lancer quelques commandes magiques. Je vous conseille pour commencer histoire de se faire une id&eacute;e des possibilit&eacute;es du makefile d'utiliser la commande :</p>
     
   <pre class="command"><kbd>make help|more</kbd>
   </pre>
     <p>Elle vous donnera TOUTES les options qui vous sont disponibles pour la compilation du kernel et de ses modules.</p>
     
   <pre class="output">Cleaning targets:
  clean           - Remove most generated files but keep the config and
                    enough build support to build external modules
  mrproper        - Remove all generated files + config + various backup files
  distclean       - mrproper + remove editor backup and patch files                                                   

Configuration targets:                                                                                                
  config          - Update current config utilising a line-oriented program
  nconfig         - Update current config utilising a ncurses menu based program
  menuconfig      - Update current config utilising a menu based program
  xconfig         - Update current config utilising a QT based front-end
  gconfig         - Update current config utilising a GTK based front-end                                             
  oldconfig       - Update current config utilising a provided .config as base
  localmodconfig  - Update current config disabling modules not loaded
  localyesconfig  - Update current config converting local mods to core
  silentoldconfig - Same as oldconfig, but quietly, additionally update deps
  defconfig       - New config with default from ARCH supplied defconfig
  savedefconfig   - Save current config as ./defconfig (minimal config)
  allnoconfig     - New config where all options are answered with no
  allyesconfig    - New config where all options are accepted with yes
  allmodconfig    - New config selecting modules when possible
  alldefconfig    - New config with all symbols set to default
  randconfig      - New config with random answer to all options
  listnewconfig   - List new options
  oldnoconfig     - Same as silentoldconfig but sets new symbols to their default value

......
....
   </pre>
     
     <p>Je vous ai mis que le début <img src="../graphics/smiley-wink.gif" alt="Wink" title="Wink">. On va donc commencer par s'assurer que les sources sont propres et dépourvus de toute partie de code déjà compilée</p>
     
   <div class="note"><img src="../graphics/note.gif" width="10" height="10" alt="*" /> cette commande n'est à faire qu'à la première tentative de compilation du kernel. Il n'est plus necessaire de taper cette commande ci-dessous si vous souhaitez recompiler le kernel pour diverses raisons
   </div>
   <pre class="command"><kbd>make mrproper</kbd>
   </pre>
     
     <p>Aucun message ne doit appara&icirc;tre. Nous allons maintenant lancer l'outil de configuration afin de choisir le minimum d'options necessaire pour avoir un kernel fonctionnel. J'ai volontairement choisi l'interface non graphique en effet, vous pouvez la lancer dans une chroot , une console non graphique ou graphique.</p>
     <p>Configurer les options de compilation et lancer la compilation du kernel. L'&eacute;quipe de Linuxfromscratch recommande de d&eacute;activer la variable LC_ALL :</p>
     
   <pre class="command"><kbd>make LC_ALL= menuconfig</kbd>
   </pre>
   <div>Vous voici devant le menu principal de configuration du kernel:
   </div><br />
   <img src="http://download.tuxfamily.org/nutyx/img/installer_kernel/menuprincipal.png" alt="Configuration menu principal" title="http://download.tuxfamily.org/nutyx/img/installer_kernel/menuprincipal.png" width="578" height="517" />
   
     <p>Dans cet article, je ne vais que choisir les options indispensables au bon amor&ccedil;age du kernel et donc optenir un nombre de modules plus petit. Il faut savoir que le kernel disponible en binaire en contient plus de 3000.</p>
   <p>Naviguez à travers tous les menus et activez UNIQUEMENT les options mentionés ci-dessous. Comme vous pouvez le voir nous déactivons tous les modules, puisque ils ne sont pas necessaires dans une configuration minimaliste</p>
     
   <h1>Default kernel configuration</h1>
   <h2>General Setup</h2>
   
    <table>
     <tr class="odd"><td>Kernel compression mode (Gzip)</td>
     </tr>
     <tr class="even"><td>((none)) Default hostname</td>
     </tr>
     <tr class="odd"><td>Support for paging of anonymous memory</td>
     </tr>
     <tr class="even"><td>System V IPC</td>
     </tr>
     <tr class="odd"><td>POSIX Message Queues</td>
     </tr>
     <tr class="even"><td>(18) Kernel log buffer size</td>
     </tr>
     <tr class="odd"><td>Namespaces support</td>
     </tr>
    </table>
   <div><h2>Enable loadable module support</h2>
   </div>
   <div><h2>Enable the block layer</h2>
   </div>
    <table>
     <tr class="odd"><td style="width:20%;">IO Schedulers ---></td><td>CFQ I/O scheduler</td>
     </tr>
     <tr class="even"><td></td><td>Default I/O scheduler (CFQ)</td>
     </tr>
    </table>
   <div><h2>Processor type and features</h2></div>
    <table>
     <tr class="odd"><td>Processor family (Pentium-Pro)</td>
     </tr>
     <tr class="even"><td>High Memory Support (4GB)</td>
     </tr>
     <tr class="odd"><td>Memory model (Flat Memory))</td>
     </tr>
     <tr class="even"><td>(4096) Low address space to protect from user allocation</td>
     </tr>
     <tr class="odd"><td>(64) Amount of low memory, in kilobytes, to reserve for the BIOS</td>
     </tr>
     <tr class="even"><td>(0x1000000) Alignment value to which kernel should be aligned</td>
     </tr>
    </table>
     
   <h2>Power management and ACPI options</h2>
   <h2>Bus options (PCI,etc)</h2>
     
    <table>
     <tr class="odd"><td>PCI Support</td><td>PCI access mode (Any)</td>
     </tr>
     <tr class="even"><td>ISA Support</td>
     </tr>
     <tr class="odd"><td>EISA Support</td>
     </tr>
    </table>
   <div><h2>Executable file formats / Emulations</h2></div>
    <table>
     <tr class="odd"><td style="width:35%;">Kernel support for ELF binaries</td>
     </tr>
    </table>
   <div><h2>Networking support</h2></div>
    <table>
     <tr class="odd"><td style="width:35%;">Networking options</td><td>Packet socket</td>
     </tr>
     <tr class="even"><td></td><td>Unix domain socket</td>
     </tr>
     <tr class="odd"><td></td><td>TCP/IP networking</td>
     </tr>
    </table>
   <div><h2>Device Drivers</h2></div>
    <table>
     <tr class="odd"><td style="width:20%;">Generic Driver Options</td><td>(/sbin/hotplug) path to uevent helper</td>
     </tr>
     <tr  class="even"><td></td><td>Maintain a devtmpfs filesystem to mount at /dev</td>
     </tr>
     <tr class="odd"><td></td><td>(/sbin/hotplug) path to uevent helper</td>
     </tr>
     <tr class="even"><td></td><td>Automount devtmpfs at /dev, after the kernel  mounted the rootfs</td>
     </tr>
     <tr class="odd"><td></td><td>Userspace firmware loading support</td>
     </tr>
     <tr class="even"><td>Block devices</td><td></td>
     </tr>
     <tr class="odd"><td>SCSI device support</td><td>SCSI device support</td>
     </tr>
     <tr class="even"><td></td><td>SCSI target support</td>
     </tr>
     <tr class="odd"><td></td><td>legacy /proc/scsi/ support</td>
     </tr>
     <tr class="even"><td></td><td>SCSI disk support</td>
     </tr>
     <tr class="odd"><td>Serial ATA and Parallel ATA Drivers</td><td>ATA SFF support</td><td>ATA BMDMA support</td><td>Intel ESB, ICH, PIIX3, PIIX4 PATA/SATA support</td>
     </tr>
     <tr class="even"><td>Network device support</td><td>Ethernet driver support</td><td>Broadcom devices</td><td>Broadcom Tigon3 support (ADJUST to YOUR config)</td>
     </tr>
     <tr class="odd"><td>Input device support</td><td>Generic input layer (need for keyboard, mouse ..)</td>
     </tr>
     <tr class="even"><td></td><td>Support for memoryless force-back device</td>
     </tr>
     <tr class="odd"><td></td><td>Mouse interface</td>
     </tr>
     <tr class="even"><td></td><td>(1024) Horizontal screen resolution</td>
     </tr>
     <tr class="odd"><td></td><td>(768) Vertical screen resolution</td>
     </tr>
     <tr class="even"><td></td><td>Event interface</td>
     </tr>
     <tr class="even"><td></td><td>Keyboards</td>
     </tr>
     <tr class="odd"><td>USB support</td><td>Support for Host-side USB</td>
     </tr>
     <tr class="even"><td></td><td>Enable USB persist by default</td>
     </tr>
     <tr class="odd"><td></td><td>EHCUI HCD (USB 2.0) support</td>
     </tr>
     <tr class="even"><td></td><td>Generc EHCI driver for a platform device</td>
     </tr>
     <tr class="odd"><td></td><td>UHCI HCD (most Intel and VIA) support</td>
     </tr>
     <tr class="even"><td></td><td>USB Mass Storage support</td>
     </tr>
    </table>
     
   <h2>Firmware Drivers</h2>
   <h2>File systems (ADJUST to YOUR file system)</h2>
   
    <table>
     <tr class="odd"><td>Reiserfs support</td>
     </tr>
     <tr class="even"><td>Stats in proc/fs/reiserfs</td>
     </tr>
     <tr class="odd"><td>ReiserFS extended attributes</td>
     </tr>
    </table>
     
   <h2>Kernel hacking</h2>
     
    <table>
     <tr class="odd"><td>Early printk</td>
     </tr>
    </table>
     
   <h2>Security options</h2>
     
   <h2>Cryptographic API</h2>
   
    <table>
     <tr class="odd"><td>AES cipher algorithms</td>
     </tr>
    </table>
     
   <h2>Virtualization</h2>
   
   <h2>Library routines</h2>
   
    <table>
     <tr class="odd"><td>CRC32/CRC32c functions</td>
     </tr>
    </table>
     
   <table>
    <tr>Une fois le choix effectué, vous chosissez l'option <span style="color: #ff0000;">Exit</span> jusqu'au retour au prompt de la console.</tr>
   <tr>Un nouveau message vous demande si vous souhaitez sauvergarder votre configuration, chosissez simplement l'option de défaut <span style="color: #ff0000;">Yes</span>. Un joli message apparait dans votre terminal <img src="../graphics/smiley-cool.gif" border="0" alt="Cool" title="Cool" /> :</tr>
       </table>
   <pre class="output">#
# configuration written to .config
#


<b>* End of the configuration.
*</b> Execute 'make' to start the build or try 'make help'
   </pre>
       
   <p>La compilation du kernel peut commencer. Tapez dans la console</p>
   <pre class="command"><kbd>make</kbd>
   </pre>
   <p>La compilation est démarrée</p>
   <img src="http://download.tuxfamily.org/nutyx/img/installer_kernel/Compile.png" border="0" alt="Compilation en cours" width="578" height="517" />
   
       <p>Quelques minutes (ou quelques heures plus tard, ... Vous voilà avec un kernel prêt à être installé</p>
       
   <pre class="output">Kernel: arch/x86/boot/bzImage is ready  (#1)
   </pre>
       
   <h4>Installer les modules et le kernel dans les bons dossiers</h4>
   
       <p>Le plus dur est fait. Si malgré tout vous avez optez pour l'utilisation de modules, il faut maintenant installer les modules du kernel, tapez dans la console :</p>
       
   <pre class="command"><kbd>make modules_install</kbd>
   </pre>
   
       <p>Les quelques modules compilés vont se mettre directement au bon endroit. Il faut maintenant copier le kernel qui a été compilé au bon endroit cad dans le dossier /boot:</p>
       
   <pre class="command"><kbd>cp -v arch/x86/boot/bzImage /boot/kernel-3.12.3</kbd>
   </pre>
       
    <p>Il faut encore faire un lien afin de pouvoir booter sur le kernel adéquoit. </p>
       
   <div class="important"><img src="../graphics/caution.gif" width="10" height="10" alt="!!!" /> La commande ci-dessous VARIE en fonction de la situation. Si vous compilez le kernel alors que vous &ecirc;tes dans l'installeur, choisissez l' option 1.&nbsp;Si vous compilez le kernel depuis une NuTyX fonctionnelle, choisissez l' option 2
   </div>
       
   <p>Option 1:</p>
       
   <pre class="command"><kbd>ln -s kernel-3.12.3 /boot/kernel</kbd>
   </pre>
   
       <p>Option 2 :</p>
       
   <p>Comme on ne veut pas écraser le lien existant du kernel, on va créer un nouveau lien dans les fichiers <strong><span style="color: #339966;">grub.cfg</span> </strong>et <strong><span style="color: #339966;">menu.lst</span></strong>
   </p>
   <pre class="command"><kbd>ln -s &nbsp;kernel-3.12.3 /boot/kernelAmoi</kbd>
   </pre>
   <p>Optionnel (si vous avez déjà un kernel) créer une nouvelle entrée dans le fichier grub.cfg ou menu.lst
   </p>
       
   <div class="note"><img src="../graphics/note.gif" width="10" height="10" alt="*" /> Cette page ne concerne pas le cas où le kernel a été (courageusement) compilé lors de l'installation.<span style="font-size: small;"/>
   </div>
       
   <p>On a donc choisi d'appeller notre kernel "kernelAmoi", on aurai pu l'appeler évidement autrement. Voici le contenu des fichiers menu.lst (grub 0.97) et grub.cfg (grub 2.00) pour avoir la possibilitée de booter sur le kernel fraîchement compilé. Seule la nouvelle entrée est ajoutée et dans ces exemples on suppose que NuTyX est sur la deuxième partition du premier disque dur :</p>
   <p>1. menu.lst</p>
       
   <pre class="output">...
# (3) NuTyX sur /dev/sda2
title NuTyX avec kernel experimental sur /dev/sda2
root (hd0,1)
kernel /boot/kernelAmoi root=/dev/sda2 ro quiet
   </pre>
   
       <p>2. grub.cfg</p>
   
   <pre class="output"> ....
 
menuentry "NuTyX avec kernel experimental sur /dev/sda2" {
  set root=(hd0,2)
  linux /boot/kernelAmoi root=/dev/sda2 ro quiet
}
   </pre>
   <p>Et voilà de cette façon, vous pourrez toujours choisir au démarrage de votre NuTyX sur quel kernel celle-ci doit être lancée.</p>

     
        <!-- DEBUT FOOTER -->
     
    <footer>
        <p id="foot">... <img src="../graphics/logo_nutyx_25.png" alt="nutyx petit logo"> ...<br />
        &copy; 2007 - 2014 <a href="http://nutyx.org">NuTyX</a> | Design by <a href="http://ptite.cahouet.net">La ptite Cahouet</a>.</p>
    </footer>
 </body>
</html>

